<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboards - PLMun Engage</title>
    <link rel="stylesheet" href="leaderboard.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
    <div class="sidebar">
        <div class="logo-details">
            <i class='bx bxs-graduation'></i>
            <span class="logo_name">PLMun Engage</span>
        </div>
        <ul class="nav-links">
            
            <li><a href="../student.html"><i class='bx bxs-dashboard'></i><span class="link_name">Dashboard</span></a></li>
            <li><a href="../Profile/profile.html"><i class='bx bxs-user-circle'></i><span class="link_name">My Profile</span></a></li>
            <li><a href="#" class="active"><i class='bx bxs-trophy'></i><span class="link_name">Leaderboards</span></a></li>
            <li><a href="../Reports/report.html"><i class='bx bxs-bar-chart-alt-2'></i><span class="link_name">Reports</span></a></li>
            <li><a href="../shop/shop.html"><i class='bx bxs-store-alt'></i><span class="link_name">Item Shop</span></a></li>
            <li class="log_out"><a href="#" onclick="logout()"><i class='bx bx-log-out'></i><span class="link_name">Logout</span></a></li>
        </ul>
    </div>

    <section class="home-section">
        <nav>
            <span class="dashboard">Leaderboards</span>
            <div class="stats">
                <div class="stat-item"><i class='bx bxs-coin-stack' style="color:gold"></i> <span id="coin-count">500</span></div>
                <div class="stat-item"><i class='bx bxs-star' style="color:cyan"></i> LVL <span id="level">1</span></div>
            </div>
        </nav>

        <div class="home-content">
            <!-- Loading State -->
            <div id="loadingState" class="leaderboard-card glass" style="text-align: center; padding: 40px;">
                <div style="display: inline-block; width: 50px; height: 50px; border: 5px solid rgba(0,212,255,0.3); border-top-color: #00d4ff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
                <p>Loading rankings...</p>
            </div>

            <!-- No Data State -->
            <div id="noDataState" class="leaderboard-card glass" style="display: none; text-align: center; padding: 40px;">
                <i class='bx bxs-trophy' style="font-size: 60px; color: #00d4ff; opacity: 0.5; margin-bottom: 20px;"></i>
                <h2>No Rankings Yet</h2>
                <p style="opacity: 0.8; margin-top: 10px;">Be the first to complete a quiz and climb the leaderboard!</p>
            </div>

            <!-- Leaderboard -->
            <div id="leaderboardContent" class="leaderboard-card glass" style="display: none;">
                <div class="table-header">
                    <h2><i class='bx bx-award'></i> Top Players</h2>
                    <p style="font-size: 14px; opacity: 0.8; margin-top: 5px;">Rankings based on total coins earned</p>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Quizzes</th>
                                <th>Avg Score</th>
                                <th>Total Coins</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 16px;
        }
        
        .rank-1 {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .rank-2 {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
            color: #000;
            box-shadow: 0 0 15px rgba(192, 192, 192, 0.5);
        }
        
        .rank-3 {
            background: linear-gradient(135deg, #CD7F32, #B8860B);
            color: #fff;
            box-shadow: 0 0 15px rgba(205, 127, 50, 0.5);
        }
        
        .rank-other {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .current-user-row {
            background: rgba(0, 212, 255, 0.2);
            border-left: 4px solid #00d4ff;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBlUY50heKZ_bp-PZUr76S0SiI1_zN6aOA",
            authDomain: "plmun-engage.firebaseapp.com",
            projectId: "plmun-engage",
            storageBucket: "plmun-engage.firebasestorage.app",
            messagingSenderId: "701791153164",
            appId: "1:701791153164:web:45422fd17af3493a04d229"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../../../index.html';
                return;
            }
            
            currentUser = user;
            
            // Get current user data
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                document.getElementById('coin-count').textContent = userData.coins || 500;
                document.getElementById('level').textContent = userData.level || 1;
            }
            
            // Load leaderboard
            await loadLeaderboard();
        });
        
        async function loadLeaderboard() {
            try {
                // Get all quiz results
                const resultsRef = collection(db, 'quizResults');
                const resultsSnapshot = await getDocs(resultsRef);
                
                if (resultsSnapshot.empty) {
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('noDataState').style.display = 'block';
                    return;
                }
                
                // Aggregate data by user
                const userStats = {};
                
                resultsSnapshot.docs.forEach(doc => {
                    const result = doc.data();
                    
                    if (!userStats[result.userId]) {
                        userStats[result.userId] = {
                            userId: result.userId,
                            userName: result.userName,
                            totalCoins: 0,
                            totalQuizzes: 0,
                            totalScore: 0,
                            totalQuestions: 0
                        };
                    }
                    
                    userStats[result.userId].totalCoins += result.coinsEarned || 0;
                    userStats[result.userId].totalQuizzes++;
                    userStats[result.userId].totalScore += result.score;
                    userStats[result.userId].totalQuestions += result.totalQuestions;
                });
                
                // Convert to array and calculate averages
                const rankings = Object.values(userStats).map(user => ({
                    ...user,
                    avgScore: Math.round((user.totalScore / user.totalQuestions) * 100)
                }));
                
                // Sort by total coins (descending)
                rankings.sort((a, b) => b.totalCoins - a.totalCoins);
                
                // Display leaderboard
                displayLeaderboard(rankings);
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('leaderboardContent').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                document.getElementById('loadingState').innerHTML = '<p style="color: #ff4b2b;">Failed to load leaderboard. Please try again.</p>';
            }
        }
        
        function displayLeaderboard(rankings) {
            const tableBody = document.getElementById('leaderboardTable');
            
            tableBody.innerHTML = rankings.map((user, index) => {
                const rank = index + 1;
                const isCurrentUser = user.userId === currentUser.uid;
                
                let rankBadgeClass = 'rank-other';
                let rankIcon = rank;
                
                if (rank === 1) {
                    rankBadgeClass = 'rank-1';
                    rankIcon = 'ðŸ¥‡';
                } else if (rank === 2) {
                    rankBadgeClass = 'rank-2';
                    rankIcon = 'ðŸ¥ˆ';
                } else if (rank === 3) {
                    rankBadgeClass = 'rank-3';
                    rankIcon = 'ðŸ¥‰';
                }
                
                return `
                    <tr class="${isCurrentUser ? 'current-user-row' : ''}">
                        <td>
                            <div class="rank-badge ${rankBadgeClass}">
                                ${rankIcon}
                            </div>
                        </td>
                        <td>
                            <strong>${user.userName}</strong>
                            ${isCurrentUser ? '<span style="color: #00d4ff; font-size: 12px; margin-left: 5px;">(You)</span>' : ''}
                        </td>
                        <td>${user.totalQuizzes}</td>
                        <td class="${user.avgScore >= 70 ? 'top-rank' : ''}">${user.avgScore}%</td>
                        <td class="coin-gain">
                            <i class='bx bxs-coin-stack'></i> ${user.totalCoins}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        window.logout = async function() {
            try {
                await signOut(auth);
                window.location.href = '../../../index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };
    </script>
</body>
</html>