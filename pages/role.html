<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Role - PLMun Engage</title>
    <link rel="stylesheet" href="role.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
    <div class="wrapper">
        <form action="">
            <h1>Are you a <br>STUDENT or a PROFESSOR?</h1>
            <p class="subtitle">Please select your role to access your personalized dashboard.</p>
            
            <div class="role-selection">
                <button type="button" class="role-btn" onclick="selectRole('student')">
                    <i class='bx bxs-graduation'></i>
                    <span>Student</span>
                </button>

                <button type="button" class="role-btn" onclick="selectRole('professor')">
                    <i class='bx bxs-briefcase-alt-2'></i>
                    <span>Professor</span>
                </button>
            </div>

            <div class="register-link">
                <p>Wrong account? <a href="#" onclick="logout()">Logout</a></p>
            </div>
        </form>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlUY50heKZ_bp-PZUr76S0SiI1_zN6aOA",
            authDomain: "plmun-engage.firebaseapp.com",
            projectId: "plmun-engage",
            storageBucket: "plmun-engage.firebasestorage.app",
            messagingSenderId: "701791153164",
            appId: "1:701791153164:web:45422fd17af3493a04d229"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // ✅ NEW: Check if user already has a role and redirect accordingly
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Not logged in, redirect to login
                window.location.href = '../index.html';
                return;
            }
            
            // ✅ Check if user already selected a role
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    // If role already exists, redirect to appropriate dashboard
                    if (userData.role === 'student') {
                        console.log('✅ User already has student role, redirecting...');
                        window.location.href = 'Student/Classes/student-classes.html';
                        return;
                    } else if (userData.role === 'professor') {
                        console.log('✅ User already has professor role, redirecting...');
                        window.location.href = 'professor/professor.html';
                        return;
                    }
                    
                    // No role selected yet, let them choose
                    console.log('❓ No role selected, showing role selection');
                }
            } catch (error) {
                console.error('⚠️ Error checking user role:', error);
                // If error, still show role selection as fallback
            }
        });
        
        // Make functions global so onclick can access them
        window.selectRole = async function(role) {
            const user = auth.currentUser;
            
            if (!user) {
                alert('Please log in first');
                window.location.href = '../index.html';
                return;
            }
            
            try {
                // ✅ UPDATED: Save role permanently
                await updateDoc(doc(db, 'users', user.uid), {
                    role: role,
                    roleSelectedAt: new Date().toISOString()
                });
                
                console.log('✅ Role permanently saved:', role);
                
                // Redirect based on role
                if (role === 'student') {
                    window.location.href = 'Student/Classes/student-classes.html';
                } else if (role === 'professor') {
                    window.location.href = 'professor/professor.html';
                }
                
            } catch (error) {
                console.error('❌ Error saving role:', error);
                alert('Failed to save role. Please try again.');
            }
        };
        
        window.logout = async function() {
            try {
                await signOut(auth);
                window.location.href = '../index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };
    </script>
</body>
</html>